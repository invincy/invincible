<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invincible</title>

  <!-- Favicon (inline SVG, no file needed) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%23003333"/><path d="M12 48 L24 16 L32 36 L40 16 L52 48" stroke="%2300ffff" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>' />
  <meta name="theme-color" content="#003333"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <!-- Futuristic clock font -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --neon:#00ffff;
      --bg-color:#000;
      --accent-color:#00ffff;
      --subtle-color:#003333;
      --font-color:#e0e6ec;
      --glow-color:#00ffff;
      --panel-bg:rgba(0,51,51,.3);
      --panel-border:1px solid rgba(0,255,255,.2);
      --panel-shadow:0 0 15px rgba(0,255,255,.2);
    }

    html,body{height:100%;margin:0;overflow:hidden;font-family:Roboto,system-ui,Arial,sans-serif;color:var(--font-color);background:var(--bg-color)}
    body{display:flex;flex-direction:column;position:relative}

    /* Particles */
    #particles-js{position:absolute;inset:0;z-index:1;opacity:.5}

    /* Cards */
    .task-card{position:relative;padding:1.2rem 1rem .9rem; padding-top:2rem; overflow:visible; background:transparent; border:var(--panel-border); border-radius:.5rem; color:var(--accent-color); transition:.15s}
    .task-card:hover{transform:translateY(-2px);border-color:var(--accent-color);box-shadow:0 0 10px rgba(0,255,255,.3)}
    .task-card h3{margin:0 0 .25rem;font-size:.95rem;font-weight:400;color:var(--accent-color);text-shadow:0 0 2px var(--glow-color)}
    .task-card .subtask-count{font-size:.75rem;opacity:.75;color:var(--accent-color)}
    .task-card.dragging{opacity:.5;transform:scale(.98)}

    /* Card arrows */
    .card-nav{position:absolute;top:6px;right:8px;display:flex;gap:6px;z-index:10}
    .card-nav button{display:inline-grid;place-items:center;height:22px;width:22px;background:rgba(0,255,255,.08);border:1px solid rgba(0,255,255,.35);color:var(--accent-color);border-radius:6px;cursor:pointer;box-shadow:0 0 6px rgba(0,255,255,.25)}
    .card-nav button:hover{background:rgba(0,255,255,.18)}
    .card-nav button:disabled{opacity:.35;cursor:default}

    /* Layout */
    #dashboard{display:flex;flex-direction:column;width:100vw;height:100vh;padding:1.5rem;box-sizing:border-box;gap:1.5rem;position:relative;z-index:2}
    #top-bar{display:flex;flex-direction:column;padding:1rem 1.5rem;background:var(--panel-bg);border-radius:.75rem;border:var(--panel-border);box-shadow:var(--panel-shadow);z-index:10}
    #time-and-date-row{display:flex;justify-content:space-between;align-items:center}
    #controls-row{display:flex;justify-content:space-between;align-items:center;padding-top:1rem;border-top:1px solid rgba(0,255,255,.2);margin-top:1rem}

    /* Title on the left */
    #app-title{font-size:1.3rem;letter-spacing:.12rem;text-transform:uppercase;color:var(--accent-color);text-shadow:0 0 6px var(--glow-color)}

    .controls{display:flex;align-items:center;gap:1rem}
    .add-task-btn{background:transparent;color:var(--accent-color);border:1px solid var(--accent-color);padding:.6rem .9rem;border-radius:.75rem;font-size:1rem;cursor:pointer;transition:.2s;text-shadow:0 0 5px var(--glow-color)}
    .add-task-btn:hover{background:rgba(0,255,255,.1);box-shadow:0 0 10px rgba(0,255,255,.5)}

    /* Kanban + Side Panel */
    #kanban-container{display:flex;flex:1;gap:1.5rem;overflow-x:auto;align-items:stretch;position:relative}
    .kanban-column{flex:1;min-width:250px;max-width:350px;display:flex;flex-direction:column;background:var(--panel-bg);border:var(--panel-border);border-radius:.75rem;overflow:hidden;padding:1rem .5rem;position:relative;z-index:2;transition:.2s}
    .kanban-column:hover{box-shadow:0 0 20px rgba(0,255,255,.4)}
    .kanban-column h2{font-weight:400;text-align:center;text-transform:uppercase;font-size:1.1rem;padding:.5rem 0;margin:0 0 1rem;border-bottom:1px solid rgba(0,255,255,.3);color:var(--accent-color);text-shadow:0 0 5px var(--glow-color);opacity:.9}
    .task-list{flex-grow:1;overflow-y:auto;display:flex;flex-direction:column;gap:.75rem;padding:0 .5rem}

    /* SIDE WIDGET (Clock + Countdowns) */
    #left-info{flex:0 0 360px;display:flex;flex-direction:column;gap:1rem;background:var(--panel-bg);border:var(--panel-border);border-radius:.75rem;padding:1rem;position:relative;z-index:2}
    #left-info .section-title{font-weight:400;text-transform:uppercase;letter-spacing:.5px;margin:0;color:var(--accent-color);text-shadow:0 0 6px var(--glow-color);opacity:.9;border-bottom:1px solid rgba(0,255,255,.3);padding-bottom:.5rem}

    /* Big funky clock */
    .mega-clock{font-family:'Orbitron', system-ui, Arial, sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,255,255,.08), rgba(0,255,255,.02));border:var(--panel-border);border-radius:.75rem;padding:1rem 1rem 1.25rem;box-shadow:0 0 20px rgba(0,255,255,.25) inset, 0 0 25px rgba(0,255,255,.15);position:relative;overflow:hidden}
    .time{font-size:3.2rem;line-height:1;letter-spacing:.06em;color:var(--accent-color);text-shadow:0 0 10px var(--glow-color), 0 0 20px rgba(0,255,255,.4);animation:pulse 2.2s ease-in-out infinite}
    .date{margin-top:.4rem;font-size:1rem;opacity:.9;color:var(--accent-color);text-shadow:0 0 6px var(--glow-color)}
    @keyframes pulse{0%,100%{transform:translateZ(0) scale(1)}50%{transform:translateZ(0) scale(1.02)}}

    /* Countdowns */
    .countdowns{display:flex;flex-direction:column;gap:.6rem}
    .countdowns-header{display:flex;align-items:center;gap:.5rem;justify-content:space-between}
    .countdowns-header h2{color:var(--accent-color);text-shadow:0 0 6px var(--glow-color);font-weight:400;text-transform:uppercase;letter-spacing:.5px;margin:0}
    .icon-btn{display:inline-grid;place-items:center;height:30px;width:30px;border-radius:.6rem;background:rgba(0,255,255,.08);border:1px solid rgba(0,255,255,.35);color:var(--accent-color);cursor:pointer}
    .icon-btn:hover{background:rgba(0,255,255,.18)}
    .countdown-item{display:flex;justify-content:space-between;align-items:center;background:rgba(0,51,51,.5);padding:.5rem 1rem;border-radius:.5rem;border:var(--panel-border);color:var(--neon);min-width:260px}
    .countdown-item button{background:transparent;border:none;color:var(--accent-color);cursor:pointer;opacity:.6}
    .countdown-item button:hover{opacity:1}
    .mini-form{display:flex;gap:.4rem;align-items:center;background:var(--panel-bg);border:var(--panel-border);border-radius:.6rem;padding:.5rem;box-shadow:var(--panel-shadow)}
    .mini-form input{background:rgba(0,51,51,.5);border:1px solid rgba(0,255,255,.2);color:var(--font-color);padding:.4rem;border-radius:.4rem}
    .hidden{display:none}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);display:flex;justify-content:center;align-items:center;z-index:9999;opacity:0;visibility:hidden;transition:.25s}
    .modal-overlay.open{opacity:1;visibility:visible}
    .modal{background:var(--subtle-color);border:var(--panel-border);box-shadow:var(--panel-shadow);border-radius:1rem;padding:2rem;width:90%;max-width:600px;max-height:90vh;overflow:auto;display:flex;flex-direction:column;gap:1rem;color:var(--font-color)}
    .modal h2{font-weight:300;margin:0;text-align:center;color:var(--accent-color);text-shadow:0 0 5px var(--glow-color)}
    .modal-field{display:flex;flex-direction:column}
    .modal-field label{font-size:.9rem;color:rgba(255,255,255,.6);margin-bottom:.5rem}
    .modal input,.modal textarea,.modal select{background:rgba(0,255,255,.05);border:1px solid rgba(0,255,255,.2);color:var(--font-color);padding:.75rem;border-radius:.5rem}
    .modal-buttons{display:flex;gap:1rem}
    .modal-button{flex:1;padding:.75rem;border-radius:.5rem;border:none;cursor:pointer;color:var(--font-color)}
    .modal-button.save{background:var(--accent-color);color:var(--bg-color)}
    .modal-button.delete{background:#e74c3c}
    .modal-button.close{background:#7f8c8d}

    /* Scrollbars */
    ::-webkit-scrollbar{width:12px;height:12px}
    ::-webkit-scrollbar-track{background:rgba(0,255,255,.05);border-radius:6px}
    ::-webkit-scrollbar-thumb{background:rgba(0,255,255,.4);border-radius:6px;border:3px solid rgba(0,255,255,.1);box-shadow:0 0 5px rgba(0,255,255,.5)}
    ::-webkit-scrollbar-thumb:hover{background:rgba(0,255,255,.6);box-shadow:0 0 10px rgba(0,255,255,.8)}

    /* Streaks */
    .streak-buttons{display:flex;gap:1rem}
    .streak-button{background:none;border:none;font-size:.9rem;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:.5rem;color:var(--accent-color)}
    .streak-button:hover{box-shadow:0 0 15px var(--glow-color);background:rgba(0,255,255,.1)}
    .streak-button i{font-size:1.2rem;color:var(--accent-color);text-shadow:0 0 5px var(--glow-color)}
    .streak-number{color:var(--accent-color);text-shadow:0 0 5px var(--glow-color);font-weight:700;font-size:1.2rem}

    @media (max-width:1024px){#kanban-container{flex-direction:column;overflow-y:auto;overflow-x:hidden}.kanban-column{min-width:unset;max-width:unset;min-height:unset}#left-info{flex:unset}}
    @media (max-width:768px){#dashboard{padding:.5rem;gap:.5rem}#top-bar{padding:.5rem}}
  </style>
</head>
<body>
  <canvas id="particles-js"></canvas>

  <div id="dashboard">
    <div id="top-bar">
      <div id="time-and-date-row">
        <div id="app-title">Invincible</div>
        <div class="controls">
          <button id="add-task-btn-top" class="add-task-btn"><i class="fas fa-plus"></i> New Task</button>
        </div>
      </div>

      <div id="controls-row">
        <div class="streaks">
          <div class="streak-buttons">
            <button class="streak-button" data-type="body"><i class="fas fa-dumbbell"></i><span class="streak-number" id="streak-body">0</span></button>
            <button class="streak-button" data-type="mind"><i class="fas fa-brain"></i><span class="streak-number" id="streak-mind">0</span></button>
            <button class="streak-button" data-type="spirit"><i class="fas fa-spa"></i><span class="streak-number" id="streak-spirit">0</span></button>
          </div>
        </div>
        <!-- Countdown/clock moved to right panel -->
        <div style="height:1px;"></div>
      </div>
    </div>

    <div id="kanban-container">
      <!-- LEFT SIDE WIDGET -->
      <aside id="left-info">
        <h2 class="section-title">Clock</h2>
        <div class="mega-clock">
          <div id="live-clock-time" class="time">--:--:--</div>
          <div id="live-clock-date" class="date">-- --- ----</div>
        </div>

        <div class="countdowns">
          <div class="countdowns-header">
            <h2>Countdowns</h2>
            <div style="display:flex;gap:.5rem">
              <button id="toggle-ctd-form" class="icon-btn" title="Add countdown"><i class="fas fa-plus"></i></button>
            </div>
          </div>
          <div id="countdown-list"></div>
          <div id="countdown-mini" class="mini-form hidden">
            <input type="text" id="countdown-mini-title" placeholder="Event" />
            <input type="datetime-local" id="countdown-mini-datetime" />
            <button id="mini-add" class="icon-btn" title="Save"><i class="fas fa-check"></i></button>
          </div>
        </div>
      </aside>

      <div id="kanban-backlog" class="kanban-column"><h2>Backlog</h2><div class="task-list" data-status="Backlog"></div></div>
      <div id="kanban-today" class="kanban-column"><h2>Today</h2><div class="task-list" data-status="Today"></div></div>
      <div id="kanban-in-progress" class="kanban-column"><h2>In Progress</h2><div class="task-list" data-status="In Progress"></div></div>
      <div id="kanban-done" class="kanban-column"><h2>Done</h2><div class="task-list" data-status="Done"></div></div>
    </div>
  </div>

  <!-- Task Modal -->
  <div id="task-modal-overlay" class="modal-overlay">
    <div id="task-modal" class="modal">
      <h2>Edit Task</h2>
      <div class="modal-field"><label for="modal-title">Title</label><input type="text" id="modal-title"></div>
      <div class="modal-field"><label for="modal-description">Description</label><textarea id="modal-description" rows="4"></textarea></div>
      <div class="modal-field">
        <label for="modal-status">Status</label>
        <select id="modal-status">
          <option value="Backlog">Backlog</option>
          <option value="Today">Today</option>
          <option value="In Progress">In Progress</option>
          <option value="Done">Done</option>
        </select>
      </div>
      <div class="modal-field">
        <label>Subtasks</label>
        <div id="modal-subtasks-list" class="subtasks-list"></div>
        <button id="add-subtask-btn" class="modal-button save" style="margin-top:.5rem"><i class="fas fa-plus"></i> Add Subtask</button>
      </div>
      <div class="modal-buttons">
        <button id="save-task-btn" class="modal-button save">Save</button>
        <button id="delete-task-btn" class="modal-button delete" style="display:none">Delete</button>
        <button id="close-modal-btn" class="modal-button close">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== CONFIG: your Apps Script deployment ===== */
    const API = "https://script.google.com/macros/s/AKfycbyFO00mXXPQvrq7mSNhlmaaSerOlDIfhNeMhkT0De__97vTTNZ0CKxsTDfLtkCVW_h8JA/exec";

    async function api(action, body={}) {
      try{
        const res = await fetch(API, { method:'POST', body: JSON.stringify({ action, body }) });
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || 'API error');
        return json.data;
      }catch(err){
        console.error('API call failed:', err);
        throw err; // Re-throw to be caught by the calling function
      }
    }

    /* ===== State ===== */
    let dragId = null;
    let tasks=[], streaks={}, countdowns=[];
    let draggedTask=null, originalStatus=null;
    const STATUSES = ['Backlog','Today','In Progress','Done'];

    function normalizeStreaks(s){
      const read = (x)=> typeof x === 'number' ? x : (x && (x.streak ?? x.value ?? x.count ?? 0)) || 0;
      return { body: read(s?.body), mind: read(s?.mind), spirit: read(s?.spirit) };
    }

    async function resetStreaksIfNeeded(){
      const now = Date.now();
      for(const type of ['body','mind','spirit']){
        const last = Number(localStorage.getItem('streak-last-'+type) || 0);
        if(now - last > 86400000 && streaks[type] !== 0){
          streaks[type] = 0;
          try{ await api('updateStreak', { type, value: 0 }); }catch(err){ console.error('Reset failed', err); }
        }
      }
      renderStreaks();
    }

    /* ===== Elements ===== */
    const taskLists = {
      "Backlog": document.querySelector('#kanban-backlog .task-list'),
      "Today": document.querySelector('#kanban-today .task-list'),
      "In Progress": document.querySelector('#kanban-in-progress .task-list'),
      "Done": document.querySelector('#kanban-done .task-list'),
    };
    const modalOverlay = document.getElementById('task-modal-overlay');
    const modal = document.getElementById('task-modal');
    const modalTitleEl = modal.querySelector('h2');
    const modalTitle = document.getElementById('modal-title');
    const modalDescription = document.getElementById('modal-description');
    const modalStatus = document.getElementById('modal-status');
    const modalSubtasks = document.getElementById('modal-subtasks-list');
    const saveTaskBtn = document.getElementById('save-task-btn');
    const deleteTaskBtn = document.getElementById('delete-task-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const addSubtaskBtn = document.getElementById('add-subtask-btn');
    const addTaskBtnTop = document.getElementById('add-task-btn-top');

    let saving = false;
    let deleting = false;

    const countdownListEl = document.getElementById('countdown-list');
    const toggleMini = document.getElementById('toggle-ctd-form');
    const miniWrap = document.getElementById('countdown-mini');
    const miniTitle = document.getElementById('countdown-mini-title');
    const miniDate  = document.getElementById('countdown-mini-datetime');
    const miniAdd   = document.getElementById('mini-add');

    /* ===== Load + render ===== */
    async function fetchDataAndRender(){
      const data = await api("getAll");
      tasks = data.tasks || [];
      streaks = normalizeStreaks(data.streaks || {});
      countdowns = data.countdowns || [];
      renderTasks();
      await resetStreaksIfNeeded();
      renderCountdowns();
    }

    function renderTasks(){
      Object.values(taskLists).forEach(list=> list.innerHTML='');
      tasks.forEach(task=>{
        const el = document.createElement('div');
        el.className = 'task-card'; el.draggable = true; el.dataset.id = task.id;
        const subs = task.subtasks || []; const done = subs.filter(s=>s.done).length; const total = subs.length;
        el.innerHTML = `
          <div class="card-nav">
            <button class="nav-left" title="Move left">‹</button>
            <button class="nav-right" title="Move right">›</button>
          </div>
          <h3>${escapeHtml(task.title||'')}</h3>
          <div class="subtask-count">${ total? `${done}/${total}` : 'No'} subtasks</div>`;

        const pos = STATUSES.indexOf(task.status);
        const leftBtn = el.querySelector('.nav-left');
        const rightBtn = el.querySelector('.nav-right');
        leftBtn.disabled = (pos<=0); rightBtn.disabled = (pos>=STATUSES.length-1);
        leftBtn.addEventListener('click', ev=>{ ev.stopPropagation(); moveTask(task.id,-1); });
        rightBtn.addEventListener('click',ev=>{ ev.stopPropagation(); moveTask(task.id,+1); });

        el.addEventListener('click', ()=> openModal(task));
        el.addEventListener('dragstart', e=>{
          draggedTask = task.id; dragId = task.id; originalStatus = task.status;
          if(e.dataTransfer){ e.dataTransfer.setData('text/plain', task.id); e.dataTransfer.effectAllowed='move'; }
          el.classList.add('dragging');
        });
        el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); draggedTask=null; dragId=null; });
        (taskLists[task.status] || taskLists.Backlog).appendChild(el);
      });
    }

    let currentTask=null;
    function openModal(task){
      currentTask = task;
      modalTitle.value = task.title || '';
      modalDescription.value = task.description || '';
      modalStatus.value = task.status || 'Backlog';
      renderSubtasks(task.subtasks || []);
      modalTitleEl.textContent = task.id ? 'Edit Task' : 'New Task';
      deleteTaskBtn.style.display = task.id ? 'block' : 'none';
      modalOverlay.classList.add('open');
    }
    function renderSubtasks(subtasks){
      modalSubtasks.innerHTML='';
      subtasks.forEach(st=>{
        const row = document.createElement('div');
        row.className = 'subtask-item';
        row.innerHTML = `
          <input type="checkbox" ${st.done ? 'checked' : ''}>
          <input type="text" value="${escapeHtml(st.text||'')}">
          <button class="delete-subtask-btn" style="background:none;border:none;color:white;cursor:pointer"><i class="fas fa-trash"></i></button>`;
        row.querySelector('.delete-subtask-btn').addEventListener('click', ()=> row.remove());
        modalSubtasks.appendChild(row);
      });
    }
    function closeModal(){ modalOverlay.classList.remove('open'); currentTask=null; }

    saveTaskBtn.addEventListener('click', async () => {
      if (saving) return;
      saving = true;

      const newSubtasks = Array.from(modalSubtasks.querySelectorAll('.subtask-item')).map(item=>({
        text: item.querySelector('input[type="text"]').value,
        done: item.querySelector('input[type="checkbox"]').checked
      }));

      const updatedTask = {
        id: currentTask ? currentTask.id : null,
        title: modalTitle.value,
        description: modalDescription.value,
        status: modalStatus.value,
        subtasks: newSubtasks
      };

      const originalState = JSON.parse(JSON.stringify(tasks));
      closeModal();
      
      const isNewTask = !updatedTask.id;
      if (isNewTask) {
        updatedTask.id = 't_' + Date.now();
        tasks.push(updatedTask);
      } else {
        const index = tasks.findIndex(t => t.id === updatedTask.id);
        if (index !== -1) {
          tasks[index] = updatedTask;
        }
      }
      renderTasks();

      try {
        await api('upsertTask', updatedTask);
      } catch (err) {
        console.error('Save failed', err);
        alert('Save failed. Rolling back changes.');
        tasks = originalState;
        renderTasks();
      } finally {
        saving = false;
        saveTaskBtn.disabled = false;
        saveTaskBtn.textContent = 'Save';
      }
    });

    async function handleDelete(){
      if (deleting) return;
      const id = currentTask && currentTask.id;
      if (!id) { alert('Cannot delete: missing task id.'); return; }
      deleting = true;
      
      const originalState = JSON.parse(JSON.stringify(tasks));
      closeModal();
      
      tasks = tasks.filter(t => t.id !== id);
      renderTasks();
      
      try {
        await api('deleteTask', { id });
      } catch (err) {
        console.error('Delete failed', err);
        alert('Delete failed. Rolling back changes.');
        tasks = originalState;
        renderTasks();
      } finally {
        deleting = false;
      }
    }

    deleteTaskBtn.addEventListener('click', handleDelete);
    closeModalBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', e=>{ if(e.target.id==='task-modal-overlay') closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    addSubtaskBtn.addEventListener('click', ()=>{
      const row = document.createElement('div'); row.className='subtask-item';
      row.innerHTML = `<input type="checkbox"><input type="text" placeholder="New subtask text"><button class="delete-subtask-btn" style="background:none;border:none;color:white;cursor:pointer"><i class="fas fa-trash"></i></button>`;
      row.querySelector('.delete-subtask-btn').addEventListener('click', ()=> row.remove());
      modalSubtasks.appendChild(row);
    });

    addTaskBtnTop.addEventListener('click', ()=> openModal({ id:null, title:'', description:'', status:'Backlog', subtasks:[] }));

    /* ===== Drag & Drop ===== */
    document.querySelectorAll('.kanban-column').forEach(column=>{
      column.addEventListener('dragover', e=>{ e.preventDefault(); column.style.boxShadow='0 0 15px rgba(0,255,255,.4)'; if(e.dataTransfer) e.dataTransfer.dropEffect='move'; });
      column.addEventListener('dragleave', ()=>{ column.style.boxShadow='0 0 15px rgba(0,255,255,.2)'; });
      column.addEventListener('drop', async e=>{
        e.preventDefault(); column.style.boxShadow='0 0 15px rgba(0,255,255,.2)';
        const taskId = e.dataTransfer?.getData('text/plain') || dragId || draggedTask; if(!taskId) return;
        const newStatus = column.querySelector('.task-list').dataset.status;
        const card = document.querySelector(`.task-card[data-id="${taskId}"]`); const oldParent = card?.parentElement;
        if(taskLists[newStatus] && card){ taskLists[newStatus].appendChild(card); }
        
        const taskObj = tasks.find(t=> t.id === taskId);
        if(taskObj && taskObj.status !== newStatus){
          const prev = taskObj.status;
          taskObj.status = newStatus;
          // Optimistically update UI
          renderTasks(); 
          try{ await api('upsertTask', taskObj); }
          catch(err){ 
            console.error('Update failed, rolling back', err); 
            taskObj.status = prev; 
            renderTasks(); 
          }
        }
      });
    });

    /* ===== Streaks ===== */
    document.querySelectorAll('.streak-button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const type = btn.dataset.type;
        const prevStreaks = JSON.parse(JSON.stringify(streaks));
        const now = Date.now();
        const last = Number(localStorage.getItem('streak-last-'+type) || 0);
        if(now - last > 86400000){
          streaks[type] = 1;
        } else {
          streaks[type] = streaks[type] + 1;
        }
        localStorage.setItem('streak-last-'+type, now);
        renderStreaks();
        try{
          await api('updateStreak',{ type, value: streaks[type] });
        } catch(err){
          console.error('Streak update failed, rolling back', err);
          streaks = prevStreaks;
          renderStreaks();
        }
      });
    });

    function renderStreaks(){
      const n = (v)=> typeof v === 'number' ? v : (v && (v.streak ?? v.value ?? v.count ?? 0)) || 0;
      document.getElementById('streak-body').textContent = n(streaks.body);
      document.getElementById('streak-mind').textContent = n(streaks.mind);
      document.getElementById('streak-spirit').textContent = n(streaks.spirit);
    }

    async function moveTask(taskId, delta){
      const idx = tasks.findIndex(t => t.id === taskId); 
      if (idx < 0) return;
      const t = tasks[idx]; 
      const curPos = STATUSES.indexOf(t.status);
      const nextPos = Math.min(STATUSES.length-1, Math.max(0, curPos + delta)); 
      if (nextPos === curPos) return;

      const newStatus = STATUSES[nextPos];
      const prevStatus = t.status;
      t.status = newStatus;

      renderTasks(); // Optimistically update UI

      try{
        await api('upsertTask', t);
      }catch(err){ 
        console.error('Move failed, rolling back', err); 
        t.status = prevStatus; 
        renderTasks(); 
      }
    }

    /* ===== Countdowns ===== */
    function renderCountdowns(){
      countdownListEl.innerHTML='';
      countdowns.forEach(c=>{
        const item = document.createElement('div'); item.className='countdown-item'; item.dataset.id=c.id;
        const del = document.createElement('button'); del.innerHTML='<i class="fas fa-trash"></i>';
        del.addEventListener('click', async ()=>{ 
          const originalState = JSON.parse(JSON.stringify(countdowns));
          countdowns = countdowns.filter(cd => cd.id !== c.id);
          renderCountdowns(); // Optimistically update
          try{
            await api('deleteCountdown', { id:c.id });
          } catch (err){
            console.error('Delete failed, rolling back', err);
            countdowns = originalState;
            renderCountdowns();
          }
        });
        item.innerHTML = `<span>${escapeHtml(c.title)}: <span class="time-left"></span></span>`;
        item.appendChild(del); countdownListEl.appendChild(item);
      });
    }

    toggleMini.addEventListener('click', ()=>{
      miniWrap.classList.toggle('hidden');
      if(!miniWrap.classList.contains('hidden')) miniTitle.focus();
    });
    miniAdd.addEventListener('click', async ()=>{
      const title = miniTitle.value.trim(); const val = miniDate.value;
      if(!title || !val) return; 

      const target_iso = new Date(val).toISOString();
      const newCountdown = { id: 'c_' + Date.now(), title, target_iso };
      const originalState = JSON.parse(JSON.stringify(countdowns));

      countdowns.push(newCountdown);
      miniTitle.value=''; miniDate.value=''; miniWrap.classList.add('hidden');
      renderCountdowns(); // Optimistically update

      try{
        await api('addCountdown', newCountdown);
      } catch(err) {
        console.error('Add failed, rolling back', err);
        countdowns = originalState;
        renderCountdowns();
      }
    });

    // Big live clock + date in right panel
    const timeEl = document.getElementById('live-clock-time');
    const dateEl = document.getElementById('live-clock-date');
    setInterval(()=>{
      const now = new Date();
      timeEl.textContent = now.toLocaleTimeString([], { hour12:false });
      dateEl.textContent = now.toLocaleDateString([], { weekday:'short', day:'2-digit', month:'short', year:'numeric' });

      document.querySelectorAll('.countdown-item').forEach(item=>{
        const c = countdowns.find(x=> x.id === item.dataset.id);
        if(!c) return; 
        const diff = new Date(c.target_iso) - now;
        item.querySelector('.time-left').textContent =
          diff>0 ? `${Math.floor(diff/86400000)}d ${Math.floor(diff%86400000/3600000)}h ${Math.floor(diff%3600000/60000)}m ${Math.floor(diff%60000/1000)}s` : 'EXPIRED';
      });
    },1000);

    /* ===== Particles ===== */
    (function(){
      const canvas = document.getElementById('particles-js');
      const ctx = canvas.getContext('2d');
      let width,height; let particles=[]; const count=100; const maxDist=100;
      function resize(){ width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
      window.addEventListener('resize', resize); resize();
      class Particle{ constructor(){ this.x=Math.random()*width; this.y=Math.random()*height; this.vx=(Math.random()-.5)*.5; this.vy=(Math.random()-.5)*.5; this.r=Math.random()*1.5+.5; } update(){ this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>width) this.vx*=-1; if(this.y<0||this.y>height) this.vy*=-1; } draw(){ ctx.beginPath(); ctx.fillStyle='#00ffff'; ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fill(); }}
      function connect(){ for(let a=0;a<count;a++){ for(let b=a+1;b<count;b++){ const dx=particles[a].x-particles[b].x, dy=particles[a].y-particles[b].y; const d=Math.hypot(dx,dy); if(d<maxDist){ ctx.beginPath(); ctx.strokeStyle=`rgba(0,255,255,${1-d/maxDist})`; ctx.lineWidth=.5; ctx.moveTo(particles[a].x,particles[a].y); ctx.lineTo(particles[b].x,particles[b].y); ctx.stroke(); } } } }
      particles = Array.from({length:count}, ()=> new Particle());
      (function loop(){ ctx.clearRect(0,0,width,height); particles.forEach(p=>{ p.update(); p.draw(); }); connect(); requestAnimationFrame(loop); })();
    })();

    /* ===== Helpers ===== */
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

    /* ===== Boot (wrap awaits inside async) ===== */
    async function init(){
      await fetchDataAndRender();
    }
    init();

    /* ===== Tests (toggle on when needed) ===== */
    const DEV_TESTS = false; // set to true in console to run
    if (DEV_TESTS) {
      (async function runTests(){
        console.log('[TEST] starting');
        // Test 1: modal open/close
        const fake = { id:null, title:'Test', description:'', status:'Backlog', subtasks:[] };
        openModal(fake);
        console.assert(modalOverlay.classList.contains('open'), 'Modal should open');
        closeModal();
        console.assert(!modalOverlay.classList.contains('open'), 'Modal should close');

        // Test 2: deleting captures id BEFORE closeModal
        const realApi = api; // mock API
        const calls = [];
        api = async (action, body)=>{ calls.push({action, body}); return action==='getAll'?{tasks:[],streaks:{},countdowns:[]}:{ } };
        const deletable = { id:'t1', title:'X', description:'', status:'Backlog', subtasks:[] };
        openModal(deletable);
        await handleDelete();
        console.assert(calls.some(c=>c.action==='deleteTask' && c.body && c.body.id==='t1'), 'deleteTask should be called with correct id');
        api = realApi; // restore

        console.log('[TEST] passed');
      })();
    }
  </script>
</body>
</html>
